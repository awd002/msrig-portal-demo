{% extends "portal/base.html" %}
{% load static %}

{% block title %}{{ proposal.title }} — Owner Dashboard{% endblock %}

{% block content %}

<style>
  /* Owner dashboard: match home card polish */
  .owner-hero .owner-pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 12px;border-radius:999px;
    background: rgba(240,180,41,.95);
    color:#1b1b1b;font-weight:900;font-size:.85rem;
  }
  .owner-hero .subtle{
    color: rgba(255,255,255,.85);
    font-weight:700;
  }

  .dash-card{
    background:white;
    border:1px solid rgba(0,0,0,.06);
    border-radius:16px;
    box-shadow:0 10px 25px rgba(0,0,0,.06);
  }
  .dash-card .card-body{ padding:16px 16px 14px; }

  .status-pill{
    font-weight:900;font-size:.78rem;letter-spacing:.02em;
    padding:6px 10px;border-radius:999px;display:inline-block;
  }
  .status-pending{ background:#fef3c7; color:#92400e; }
  .status-approved{ background:#dcfce7; color:#166534; }
  .status-rejected{ background:#fee2e2; color:#991b1b; }

  .meta-muted{ font-weight:700; font-size:.85rem; }

  .qa-block strong{ font-weight:900; }
  .qa-answer{ white-space:pre-wrap; }

  /* Button tweaks to match your rounded style */
  .btn-rounded-12{ border-radius:12px; font-weight:900; }
  .btn-rounded-10{ border-radius:10px; font-weight:900; }

  /* Make danger buttons look consistent */
  .btn-soft-danger{
    background:#fee2e2; color:#7f1d1d; border:1px solid rgba(127,29,29,.18);
    border-radius:12px; font-weight:900;
  }
  .btn-soft-danger:hover{ filter: brightness(.98); }
  .btn-soft-info{
    background:#dbeafe; color:#1e40af; border:1px solid rgba(30,64,175,.18);
    border-radius:12px; font-weight:900;
  }
  .btn-soft-info:hover{ filter: brightness(.98); }

  /* Keep forms inline like buttons */
  .inline-form{ display:inline; margin:0; }

  /* Prevent long answers from exploding layout on small screens */
  .qa-answer{ overflow-wrap:anywhere; }
</style>

<!-- HERO (same structure as home) -->
<section class="hero owner-hero">
  <div class="container">
    <div class="row justify-content-center text-center">
      <div class="col-lg-9">
        <h1 class="display-6 mb-3">{{ proposal.title }}</h1>
        <p class="lead mb-4">
          Proposal Owner Dashboard — manage signups, review answers, and control listing status.
        </p>

        <div class="d-flex gap-2 justify-content-center flex-wrap">
          <a class="btn btn-gold" href="{% url 'proposal_detail' proposal.slug %}">View Proposal</a>

          {% if proposal.status == "OPEN" %}
            <form class="inline-form" method="POST" action="{% url 'proposal_owner_close' proposal.slug token %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-soft-danger">Close Listing</button>
            </form>
          {% else %}
            <form class="inline-form" method="POST" action="{% url 'proposal_owner_reopen' proposal.slug token %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-soft-info">Reopen Listing</button>
            </form>
          {% endif %}

          <a class="btn btn-outline-light btn-rounded-12"
             href="{% url 'home' %}"
             style="padding:10px 18px;">
            Back to Browse
          </a>
        </div>

        <!-- MSRIG Callout (mirrors home callout card) -->
        <div class="mt-4 mx-auto" style="max-width: 820px;">
          <div class="p-3 p-md-4" style="background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.18); border-radius: 16px;">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <span class="owner-pill">MSRIG</span>
              <span class="subtle">
                {{ signups|length }} signup{{ signups|length|pluralize }}
                · Status:
                <span style="font-weight:900;">
                  {% if proposal.status == "OPEN" %}OPEN{% elif proposal.status == "INPROG" %}IN PROGRESS{% else %}CLOSED{% endif %}
                </span>
              </span>
            </div>
            <p class="mb-0 mt-2" style="color: rgba(255,255,255,.85);">
              Review requests below. Approve fast, reject kindly, and try not to create a coauthor uprising.
            </p>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>

<!-- TOOLBAR / SUMMARY CARD (same “floating panel” feel as home toolbar) -->
<div class="container toolbar">
  <div class="panel">
    <div class="row g-2 align-items-center">
      <div class="col-lg-8">
        <div class="text-muted" style="font-weight:800;">
          Proposal created by <span style="font-weight:900;color:#111827;">{{ proposal.created_by_name }}</span>
          · {{ proposal.created_at|date:"M j, Y" }}
        </div>
      </div>
      <div class="col-lg-4 text-lg-end">
        <span class="badge-status {% if proposal.status == "OPEN" %}badge-open{% elif proposal.status == "INPROG" %}badge-inprog{% else %}badge-closed{% endif %}">
          {% if proposal.status == "OPEN" %}OPEN{% elif proposal.status == "INPROG" %}IN PROGRESS{% else %}CLOSED{% endif %}
        </span>
      </div>
    </div>
  </div>
</div>

<!-- SIGNUPS LIST -->
<div class="container my-4">
  <div class="row g-4">
    {% if signups %}
      {% for signup in signups %}
        <div class="col-12">
          <div class="dash-card">
            <div class="card-body">

              <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
                <div>
                  <div style="font-weight:900; font-size:1.05rem;">{{ signup.volunteer_name }}</div>
                  <div class="text-muted meta-muted">{{ signup.volunteer_email }}</div>
                </div>

                <div>
                  {% if signup.status == "PENDING" %}
                    <span class="status-pill status-pending">PENDING</span>
                  {% elif signup.status == "APPROVED" %}
                    <span class="status-pill status-approved">APPROVED</span>
                  {% else %}
                    <span class="status-pill status-rejected">REJECTED</span>
                  {% endif %}
                </div>
              </div>

              {% if signup.interest_reason %}
                <hr class="my-3">
                <div style="font-weight:900; margin-bottom:6px;">Interest Statement</div>
                <div class="text-muted qa-answer">{{ signup.interest_reason }}</div>
              {% endif %}

              <hr class="my-3">
              <div style="font-weight:900; margin-bottom:6px;">Custom Question Responses</div>

              <div class="qa-block">
                {% for answer in signup.answers.all %}
                  <div class="mb-3">
                    <strong>{{ answer.question.prompt }}</strong>
                    <div class="text-muted qa-answer">{{ answer.answer|default:"N/A" }}</div>
                  </div>
                {% empty %}
                  <div class="text-muted">No custom questions.</div>
                {% endfor %}
              </div>

              {% if signup.status == "PENDING" %}
                <div class="d-flex gap-2 flex-wrap mt-3">
                  <form class="inline-form" method="POST" action="{% url 'proposal_owner_decide_signup' proposal.slug token signup.id 'approve' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-gold btn-rounded-10">Approve</button>
                  </form>

                  <form class="inline-form" method="POST" action="{% url 'proposal_owner_decide_signup' proposal.slug token signup.id 'reject' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-secondary btn-rounded-10">Reject</button>
                  </form>
                </div>
              {% endif %}

            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="col-12">
        <div class="p-4 text-center"
             style="background:white;border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.06);">
          <p class="text-muted mb-0">No signups yet. (Your future coauthors are “thinking about it.”)</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}
